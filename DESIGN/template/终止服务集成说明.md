# ç»ˆæ­¢æœåŠ¡é›†æˆè¯´æ˜

## âœ… å·²å®Œæˆçš„é›†æˆå·¥ä½œ

### 1. åˆ›å»ºæ ¸å¿ƒæœåŠ¡æ–‡ä»¶
- **`terminate_service_manager.py`** - ç»ˆæ­¢æœåŠ¡ç®¡ç†å™¨ï¼ˆå•ä¾‹æ¨¡å¼ï¼‰
  - è‡ªåŠ¨æ£€æµ‹å¹¶é‡Šæ”¾8081ç«¯å£
  - è®°å½•æ‰€æœ‰è¯·æ±‚çš„IPåœ°å€å’Œè¯¦ç»†ä¿¡æ¯
  - æ”¯æŒIPç™½åå•è¿‡æ»¤
  - æä¾›å®Œæ•´çš„è¯·æ±‚æ—¥å¿—

### 2. ä¿®æ”¹ä»£ç ç”Ÿæˆæ¨¡æ¿ (`manage.py`)

#### å¯¼å…¥ä»£ç éƒ¨åˆ†
```python
template_dir = os.path.join(os.path.dirname(os.path.dirname(os.path.dirname(__file__))), 'template')
if template_dir not in sys.path:
    sys.path.insert(0, template_dir)

try:
    from terminate_service_manager import start_terminate_service, get_terminate_service
    _TERMINATE_SERVICE_AVAILABLE = True
except ImportError:
    _TERMINATE_SERVICE_AVAILABLE = False
    print("[è­¦å‘Š] æ— æ³•å¯¼å…¥ç»ˆæ­¢æœåŠ¡ç®¡ç†å™¨ï¼Œç»ˆæ­¢æœåŠ¡åŠŸèƒ½å°†ä¸å¯ç”¨")
```

#### ä¸»å‡½æ•°å¯åŠ¨éƒ¨åˆ†
```python
if _TERMINATE_SERVICE_AVAILABLE:
    print("[å¯åŠ¨] æ­£åœ¨å¯åŠ¨ç»ˆæ­¢æœåŠ¡...")
    if start_terminate_service(port=args.terminate_port):
        print(f"[æˆåŠŸ] ç»ˆæ­¢æœåŠ¡å·²å¯åŠ¨åœ¨ç«¯å£ {args.terminate_port}")
        print(f"[æç¤º] å¯é€šè¿‡ POST http://localhost:{args.terminate_port}/terminate æ¥ç»ˆæ­¢æ­¤è¿›ç¨‹")
        print(f"[å½“å‰PID] {os.getpid()}")
    else:
        print("[å¤±è´¥] ç»ˆæ­¢æœåŠ¡å¯åŠ¨å¤±è´¥")
else:
    print("[è·³è¿‡] ç»ˆæ­¢æœåŠ¡ä¸å¯ç”¨")
```

### 3. é›†æˆç¤ºä¾‹ï¼šK_meansç®—æ³•.py

#### ä¿®æ”¹å†…å®¹ï¼š

**1. æ–‡ä»¶å¼€å¤´æ·»åŠ å¯¼å…¥**
```python
template_dir = os.path.join(os.path.dirname(os.path.dirname(__file__)))
if template_dir not in sys.path:
    sys.path.insert(0, template_dir)

try:
    from terminate_service_manager import start_terminate_service, get_terminate_service
    _TERMINATE_SERVICE_AVAILABLE = True
except ImportError:
    _TERMINATE_SERVICE_AVAILABLE = False
    print("[è­¦å‘Š] æ— æ³•å¯¼å…¥ç»ˆæ­¢æœåŠ¡ç®¡ç†å™¨ï¼Œç»ˆæ­¢æœåŠ¡åŠŸèƒ½å°†ä¸å¯ç”¨")
```

**2. mainå‡½æ•°ä¸­å¯åŠ¨æœåŠ¡**
```python
if _TERMINATE_SERVICE_AVAILABLE:
    print(f"\n[å¯åŠ¨] æ­£åœ¨å¯åŠ¨ç»ˆæ­¢æœåŠ¡åœ¨ç«¯å£ {args.terminate_port}...")
    if start_terminate_service(port=args.terminate_port):
        print(f"[æˆåŠŸ] ç»ˆæ­¢æœåŠ¡å·²å¯åŠ¨åœ¨ç«¯å£ {args.terminate_port}")
        print(f"[æç¤º] å¯é€šè¿‡ä»¥ä¸‹æ–¹å¼ç»ˆæ­¢æ­¤è¿›ç¨‹:")
        print(f"        POST http://localhost:{args.terminate_port}/terminate")
        print(f"        è¯·æ±‚ä½“: {{'port': '{os.getpid()}'}}")
        print(f"[å½“å‰PID] {os.getpid()}")
        print(f"[ç›‘å¬åœ°å€] 0.0.0.0:{args.terminate_port}")
```

**3. ç¨‹åºé€€å‡ºæ—¶æ˜¾ç¤ºæ—¥å¿—**
```python
if _TERMINATE_SERVICE_AVAILABLE:
    print("\n[ç»ˆæ­¢æœåŠ¡] æ˜¾ç¤ºè¯·æ±‚æ—¥å¿—:")
    service = get_terminate_service()
    if service and service.request_log:
        service.print_logs()
    else:
        print("  æ²¡æœ‰æ”¶åˆ°ç»ˆæ­¢è¯·æ±‚")
```

---

## ğŸš€ å¦‚ä½•ä½¿ç”¨

### è¿è¡ŒK_meansç®—æ³•ï¼ˆå·²é›†æˆç»ˆæ­¢æœåŠ¡ï¼‰

```bash
cd DESIGN/template/å†…ç½®æœåŠ¡
python K_meansç®—æ³•.py --terminate-port 8081
```

**è¾“å‡ºç¤ºä¾‹ï¼š**
```
============================================================
å¯åŠ¨ç®—æ³•: K_meansç®—æ³•
============================================================

[å¯åŠ¨] æ­£åœ¨å¯åŠ¨ç»ˆæ­¢æœåŠ¡åœ¨ç«¯å£ 8081...
[ç«¯å£å†²çª] ç«¯å£ 8081 å·²è¢«å ç”¨ï¼Œæ­£åœ¨å°è¯•é‡Šæ”¾...
[ç«¯å£å†²çª] å‘ç°è¿›ç¨‹å ç”¨ç«¯å£ 8081: python.exe (PID: 12345)
[å¼ºåˆ¶å…³é—­] æ­£åœ¨ç»ˆæ­¢è¿›ç¨‹ PID: 12345
[æˆåŠŸ] è¿›ç¨‹ 12345 å·²è¢«å¼ºåˆ¶ç»ˆæ­¢
[æˆåŠŸ] ç«¯å£ 8081 å·²é‡Šæ”¾ï¼Œç­‰å¾…ç³»ç»Ÿå›æ”¶...
[æˆåŠŸ] ç«¯å£ 8081 ç°åœ¨å¯ç”¨
[å¯åŠ¨æˆåŠŸ] HTTPç»ˆæ­¢æœåŠ¡å·²å¯åŠ¨åœ¨ç«¯å£ 8081
[ç›‘å¬åœ°å€] 0.0.0.0:8081
[å½“å‰è¿›ç¨‹] PID: 23456
[æˆåŠŸ] ç»ˆæ­¢æœåŠ¡å·²å¯åŠ¨åœ¨ç«¯å£ 8081
[æç¤º] å¯é€šè¿‡ä»¥ä¸‹æ–¹å¼ç»ˆæ­¢æ­¤è¿›ç¨‹:
        POST http://localhost:8081/terminate
        è¯·æ±‚ä½“: {'port': '23456'}
[å½“å‰PID] 23456
[ç›‘å¬åœ°å€] 0.0.0.0:8081
============================================================

[2025-11-04 15:30:00] æˆåŠŸå‘é€ç®—æ³• 'K_meansç®—æ³•' çš„çŠ¶æ€ä¿¡æ¯
å·²å‘é€ç®—æ³• 'K_meansç®—æ³•' çš„ä¿¡æ¯åˆ° 127.0.0.1:12345
ç®—æ³•è¿è¡Œä¸­...
å·²æ‰§è¡Œç®—æ³• 1 æ¬¡
```

### æµ‹è¯•ç»ˆæ­¢æœåŠ¡

```bash
# ç»ˆç«¯2: è¿è¡Œæµ‹è¯•è„šæœ¬
cd DESIGN/template/å†…ç½®æœåŠ¡
python test_kmeans_terminate.py
```

**æµ‹è¯•è¾“å‡ºç¤ºä¾‹ï¼š**
```
============================================================
K_meansç®—æ³•ç»ˆæ­¢æœåŠ¡æµ‹è¯•
============================================================

[æµ‹è¯•1] æ£€æŸ¥ç»ˆæ­¢æœåŠ¡çŠ¶æ€...
[æˆåŠŸ] æœåŠ¡çŠ¶æ€: {
  "status": "200",
  "server": "TerminateService",
  "pid": 23456,
  "client_ip": "127.0.0.1",
  "client_host": "localhost:8081",
  "port": 8081
}

[ä¿¡æ¯] ç›®æ ‡è¿›ç¨‹ID: 23456
[ä¿¡æ¯] å®¢æˆ·ç«¯IP: 127.0.0.1

[æµ‹è¯•2] æŸ¥è¯¢å½“å‰æ—¥å¿—...
[æˆåŠŸ] å½“å‰æ—¥å¿—æ•°é‡: 1

  æ—¥å¿— 1:
    æ—¶é—´: 2025-11-04 15:30:15
    IP: 127.0.0.1
    æ“ä½œ: status_check

============================================================

æ˜¯å¦è¦å‘é€ç»ˆæ­¢è¯·æ±‚? (yes/no): yes

[æµ‹è¯•3] å‘é€ç»ˆæ­¢è¯·æ±‚ (PID: 23456)...
[æˆåŠŸ] å“åº”: {
  "status": "200",
  "message": "Termination signal sent to process 23456",
  "client_ip": "127.0.0.1"
}

[æç¤º] K_meansç®—æ³•è¿›ç¨‹åº”è¯¥ä¼šåœ¨å‡ ç§’å†…ç»ˆæ­¢
[è¯·æ±‚æ¥æºIP] 127.0.0.1
```

---

## ğŸ“¡ APIæ¥å£

### 1. GET /status - æŸ¥è¯¢æœåŠ¡çŠ¶æ€
```bash
curl http://localhost:8081/status
```

**å“åº”ï¼š**
```json
{
  "status": "200",
  "server": "TerminateService",
  "pid": 23456,
  "client_ip": "127.0.0.1",
  "client_host": "localhost:8081",
  "port": 8081
}
```

### 2. POST /terminate - ç»ˆæ­¢è¿›ç¨‹
```bash
curl -X POST http://localhost:8081/terminate \
  -H "Content-Type: application/json" \
  -d '{"port": "23456"}'
```

**å“åº”ï¼š**
```json
{
  "status": "200",
  "message": "Termination signal sent to process 23456",
  "client_ip": "127.0.0.1"
}
```

### 3. GET /logs - æŸ¥è¯¢è¯·æ±‚æ—¥å¿—
```bash
curl http://localhost:8081/logs
```

**å“åº”ï¼š**
```json
{
  "status": "200",
  "client_ip": "127.0.0.1",
  "logs": [
    {
      "endpoint": "/status",
      "ip": "127.0.0.1",
      "host": "localhost:8081",
      "timestamp": "2025-11-04 15:30:15",
      "action": "status_check"
    },
    {
      "endpoint": "/terminate",
      "ip": "127.0.0.1",
      "host": "localhost:8081",
      "timestamp": "2025-11-04 15:30:30",
      "action": "terminate",
      "target": "23456"
    }
  ]
}
```

---

## ğŸ” IPåœ°å€åˆ¤æ–­åŠŸèƒ½

æœåŠ¡ä¼šè‡ªåŠ¨è®°å½•æ¯ä¸ªè¯·æ±‚çš„ï¼š
- **client_ip**: å®¢æˆ·ç«¯IPåœ°å€
- **client_host**: å®¢æˆ·ç«¯ä¸»æœºå
- **timestamp**: è¯·æ±‚æ—¶é—´
- **endpoint**: è®¿é—®çš„ç«¯ç‚¹
- **action**: æ‰§è¡Œçš„æ“ä½œ
- **target**: ç›®æ ‡è¿›ç¨‹IDï¼ˆä»…terminateè¯·æ±‚ï¼‰

**æ§åˆ¶å°è¾“å‡ºç¤ºä¾‹ï¼š**
```
[çŠ¶æ€æŸ¥è¯¢] æ¥æºIP: 127.0.0.1, Host: localhost:8081
[ç»ˆæ­¢è¯·æ±‚] æ¥æºIP: 192.168.1.100, Host: 192.168.1.100:8081
[æ‰§è¡Œç»ˆæ­¢] ç›®æ ‡è¿›ç¨‹: 23456, è¯·æ±‚æ¥æº: 192.168.1.100
[æˆåŠŸ] å·²å‘ PID 23456 å‘é€ SIGTERM ä¿¡å·
```

---

## ğŸ¯ ç”Ÿæˆçš„ä»£ç è‡ªåŠ¨åŒ…å«ç»ˆæ­¢æœåŠ¡

ä½¿ç”¨ `manage.py` ç”Ÿæˆçš„æ‰€æœ‰ç®—æ³•ä»£ç éƒ½ä¼šè‡ªåŠ¨åŒ…å«ï¼š

1. âœ… å¯¼å…¥ç»ˆæ­¢æœåŠ¡ç®¡ç†å™¨
2. âœ… åœ¨å¯åŠ¨æ—¶è‡ªåŠ¨å¯åŠ¨ç»ˆæ­¢æœåŠ¡
3. âœ… æ”¯æŒ `--terminate-port` å‚æ•°
4. âœ… è‡ªåŠ¨æ£€æµ‹å¹¶é‡Šæ”¾ç«¯å£
5. âœ… è®°å½•æ‰€æœ‰è¯·æ±‚çš„IPåœ°å€
6. âœ… ç¨‹åºé€€å‡ºæ—¶æ˜¾ç¤ºè¯·æ±‚æ—¥å¿—

**ç”Ÿæˆä»£ç çš„è¿è¡Œæ•ˆæœï¼š**
```bash
python ç”Ÿæˆçš„ç®—æ³•.py --http-port 8080 --terminate-port 8081
```

---

## ğŸ“ æ³¨æ„äº‹é¡¹

### 1. ç«¯å£ç®¡ç†
- é»˜è®¤ç»ˆæ­¢æœåŠ¡ç«¯å£ï¼š`8081`
- å¦‚æœç«¯å£è¢«å ç”¨ï¼Œä¼šè‡ªåŠ¨å¼ºåˆ¶é‡Šæ”¾
- å¯é€šè¿‡ `--terminate-port` å‚æ•°è‡ªå®šä¹‰

### 2. IPç™½åå•ï¼ˆå¯é€‰ï¼‰
```python
# åªå…è®¸æœ¬åœ°è®¿é—®
start_terminate_service(port=8081, allowed_ips=['127.0.0.1'])

# å…è®¸å¤šä¸ªIP
start_terminate_service(port=8081, allowed_ips=['127.0.0.1', '192.168.1.100'])
```

### 3. ä¾èµ–åº“
```bash
pip install flask psutil requests
```

### 4. æƒé™è¦æ±‚
- å¦‚æœéœ€è¦ç»ˆæ­¢å…¶ä»–ç”¨æˆ·çš„è¿›ç¨‹ï¼Œå¯èƒ½éœ€è¦ç®¡ç†å‘˜æƒé™
- ç³»ç»Ÿè¿›ç¨‹å¯èƒ½æ— æ³•ç»ˆæ­¢

---

## âœ¨ æ ¸å¿ƒä¼˜åŠ¿

1. **è‡ªåŠ¨åŒ–**: ç”Ÿæˆçš„ä»£ç è‡ªåŠ¨åŒ…å«ç»ˆæ­¢æœåŠ¡
2. **IPè¿½è¸ª**: å®Œæ•´è®°å½•æ¯ä¸ªè¯·æ±‚çš„æ¥æº
3. **ç«¯å£ç®¡ç†**: è‡ªåŠ¨æ£€æµ‹å’Œé‡Šæ”¾è¢«å ç”¨çš„ç«¯å£
4. **æ˜“äºé›†æˆ**: åªéœ€ä¸¤è¡Œä»£ç å³å¯æ·»åŠ ç»ˆæ­¢åŠŸèƒ½
5. **å•ä¾‹æ¨¡å¼**: é¿å…é‡å¤å¯åŠ¨æœåŠ¡
6. **JSONå“åº”**: ç»Ÿä¸€çš„APIæ ¼å¼
7. **è¯¦ç»†æ—¥å¿—**: å®Œæ•´çš„è¯·æ±‚å†å²è®°å½•

---

## ğŸ”§ æ•…éšœæ’é™¤

### é—®é¢˜1: æ— æ³•å¯¼å…¥ terminate_service_manager
**è§£å†³æ–¹æ¡ˆ**: ç¡®ä¿ `terminate_service_manager.py` åœ¨ `DESIGN/template/` ç›®å½•ä¸‹

### é—®é¢˜2: ç«¯å£8081å·²è¢«å ç”¨
**è§£å†³æ–¹æ¡ˆ**: æœåŠ¡ä¼šè‡ªåŠ¨å¼ºåˆ¶é‡Šæ”¾ç«¯å£ï¼Œæˆ–ä½¿ç”¨ `--terminate-port` æŒ‡å®šå…¶ä»–ç«¯å£

### é—®é¢˜3: æ— æ³•ç»ˆæ­¢è¿›ç¨‹
**è§£å†³æ–¹æ¡ˆ**: 
- æ£€æŸ¥æ˜¯å¦æœ‰è¶³å¤Ÿçš„æƒé™
- ç¡®è®¤è¿›ç¨‹IDæ­£ç¡®
- æŸ¥çœ‹æœåŠ¡æ—¥å¿—è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯

---

## ğŸ“ æµ‹è¯•æ–¹æ³•

### æ–¹æ³•1: ä½¿ç”¨æä¾›çš„æµ‹è¯•è„šæœ¬
```bash
python test_kmeans_terminate.py
```

### æ–¹æ³•2: ä½¿ç”¨curlå‘½ä»¤
```bash
# æŸ¥è¯¢çŠ¶æ€
curl http://localhost:8081/status

# ç»ˆæ­¢è¿›ç¨‹
PID=$(curl -s http://localhost:8081/status | python -c "import sys, json; print(json.load(sys.stdin)['pid'])")
curl -X POST http://localhost:8081/terminate -H "Content-Type: application/json" -d "{\"port\": \"$PID\"}"
```

### æ–¹æ³•3: ä½¿ç”¨Python requests
```python
import requests
response = requests.get('http://localhost:8081/status')
print(response.json())
```

---

## æ€»ç»“

æ‰€æœ‰é€šè¿‡ `manage.py` ç”Ÿæˆçš„ç®—æ³•ä»£ç ç°åœ¨éƒ½è‡ªåŠ¨åŒ…å«ï¼š
- âœ… 8081ç«¯å£çš„HTTPç»ˆæ­¢æœåŠ¡
- âœ… IPåœ°å€è®°å½•å’Œåˆ¤æ–­
- âœ… è‡ªåŠ¨ç«¯å£é‡Šæ”¾
- âœ… å®Œæ•´çš„è¯·æ±‚æ—¥å¿—
- âœ… JSONæ ¼å¼çš„ç»Ÿä¸€å“åº”

**ç°åœ¨ä½ å¯ä»¥è½»æ¾åœ°è¿œç¨‹ç»ˆæ­¢ä»»ä½•ç”Ÿæˆçš„ç®—æ³•è¿›ç¨‹ï¼** ğŸ‰

