# ç®—æ³•ç»ˆæ­¢æœåŠ¡ç®¡ç†å™¨ - ä½¿ç”¨è¯´æ˜

## ğŸ“‹ æ–‡ä»¶è¯´æ˜

### 1. `terminate_service_manager.py` - æ ¸å¿ƒæœåŠ¡ç®¡ç†å™¨
æ‰€æœ‰ç”Ÿæˆçš„ç®—æ³•æ–‡ä»¶éƒ½åº”è¯¥å¯¼å…¥å¹¶ä½¿ç”¨è¿™ä¸ªæœåŠ¡ç®¡ç†å™¨ã€‚

**ä¸»è¦åŠŸèƒ½ï¼š**
- âœ… è‡ªåŠ¨æ£€æµ‹å¹¶é‡Šæ”¾8081ç«¯å£
- âœ… å¯åŠ¨HTTPç»ˆæ­¢æœåŠ¡
- âœ… è®°å½•æ‰€æœ‰è¯·æ±‚çš„IPåœ°å€å’Œè¯¦ç»†ä¿¡æ¯
- âœ… æ”¯æŒIPç™½åå•è¿‡æ»¤
- âœ… å•ä¾‹æ¨¡å¼ï¼Œé¿å…é‡å¤å¯åŠ¨
- âœ… JSONæ ¼å¼å“åº”

### 2. `ç®—æ³•è°ƒç”¨ç¤ºä¾‹.py` - ä½¿ç”¨ç¤ºä¾‹
å±•ç¤ºå¦‚ä½•åœ¨ç®—æ³•ä¸­é›†æˆç»ˆæ­¢æœåŠ¡ã€‚

### 3. `æµ‹è¯•ç»ˆæ­¢æœåŠ¡.py` - æµ‹è¯•å·¥å…·
ç”¨äºæµ‹è¯•ç»ˆæ­¢æœåŠ¡æ˜¯å¦æ­£å¸¸å·¥ä½œã€‚

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### æ­¥éª¤1: å®‰è£…ä¾èµ–
```bash
pip install flask psutil requests
```

### æ­¥éª¤2: åœ¨ç®—æ³•ä¸­é›†æˆæœåŠ¡

```python
import sys
import os
sys.path.append(os.path.dirname(os.path.abspath(__file__)))
from terminate_service_manager import start_terminate_service, get_terminate_service

def main():
    # å¯åŠ¨ç»ˆæ­¢æœåŠ¡ (8081ç«¯å£)
    if start_terminate_service(port=8081):
        print("ç»ˆæ­¢æœåŠ¡å·²å¯åŠ¨")
    
    # æ‰§è¡Œä½ çš„ç®—æ³•
    your_algorithm()
    
    # (å¯é€‰) æŸ¥çœ‹è¯·æ±‚æ—¥å¿—
    service = get_terminate_service()
    service.print_logs()

if __name__ == "__main__":
    main()
```

### æ­¥éª¤3: æµ‹è¯•æœåŠ¡

**æ–¹å¼1: ä½¿ç”¨æµ‹è¯•å·¥å…·**
```bash
# ç»ˆç«¯1: è¿è¡Œç®—æ³•
python ç®—æ³•è°ƒç”¨ç¤ºä¾‹.py

# ç»ˆç«¯2: æµ‹è¯•æœåŠ¡
python æµ‹è¯•ç»ˆæ­¢æœåŠ¡.py
```

**æ–¹å¼2: ä½¿ç”¨curlå‘½ä»¤**
```bash
# æŸ¥è¯¢çŠ¶æ€
curl http://localhost:8081/status

# å‘é€ç»ˆæ­¢è¯·æ±‚ (æ›¿æ¢12345ä¸ºå®é™…PID)
curl -X POST http://localhost:8081/terminate \
  -H "Content-Type: application/json" \
  -d '{"port": "12345"}'

# æŸ¥è¯¢æ—¥å¿—
curl http://localhost:8081/logs
```

---

## ğŸ“¡ API æ¥å£

### 1. GET `/status` - æŸ¥è¯¢æœåŠ¡çŠ¶æ€
**å“åº”ç¤ºä¾‹ï¼š**
```json
{
  "status": "200",
  "server": "TerminateService",
  "pid": 12345,
  "client_ip": "127.0.0.1",
  "client_host": "localhost:8081",
  "port": 8081
}
```

### 2. POST `/terminate` - ç»ˆæ­¢è¿›ç¨‹
**è¯·æ±‚ä½“ï¼š**
```json
{
  "port": "12345"
}
```

**å“åº”ç¤ºä¾‹ï¼š**
```json
{
  "status": "200",
  "message": "Termination signal sent to process 12345",
  "client_ip": "127.0.0.1"
}
```

### 3. GET `/logs` - æŸ¥è¯¢è¯·æ±‚æ—¥å¿—
**å“åº”ç¤ºä¾‹ï¼š**
```json
{
  "status": "200",
  "client_ip": "127.0.0.1",
  "logs": [
    {
      "endpoint": "/status",
      "ip": "127.0.0.1",
      "host": "localhost:8081",
      "timestamp": "2025-11-04 10:30:15",
      "action": "status_check"
    },
    {
      "endpoint": "/terminate",
      "ip": "192.168.1.100",
      "host": "192.168.1.100:8081",
      "timestamp": "2025-11-04 10:31:20",
      "action": "terminate",
      "target": "12345"
    }
  ]
}
```

---

## ğŸ”’ IPç™½åå•åŠŸèƒ½

### å¯ç”¨IPè¿‡æ»¤
```python
# åªå…è®¸ç‰¹å®šIPè®¿é—®
start_terminate_service(port=8081, allowed_ips=['192.168.1.100'])

# å…è®¸å¤šä¸ªIP
start_terminate_service(port=8081, allowed_ips=['192.168.1.100', '127.0.0.1'])
```

### æ‹’ç»è®¿é—®å“åº”
```json
{
  "status": "403",
  "message": "Access denied for IP: 192.168.1.200",
  "client_ip": "192.168.1.200"
}
```

---

## ğŸ” IPåœ°å€åˆ¤æ–­è¯´æ˜

æœåŠ¡ä¼šè‡ªåŠ¨è®°å½•æ¯ä¸ªè¯·æ±‚çš„ï¼š
- **`client_ip`**: å®¢æˆ·ç«¯IPåœ°å€ (`request.remote_addr`)
- **`client_host`**: å®¢æˆ·ç«¯ä¸»æœºå (`request.host`)
- **`timestamp`**: è¯·æ±‚æ—¶é—´
- **`endpoint`**: è®¿é—®çš„ç«¯ç‚¹
- **`action`**: æ‰§è¡Œçš„æ“ä½œ
- **`target`**: ç›®æ ‡è¿›ç¨‹ID (ä»…terminateè¯·æ±‚)

### æ§åˆ¶å°è¾“å‡ºç¤ºä¾‹
```
[çŠ¶æ€æŸ¥è¯¢] æ¥æºIP: 192.168.1.100, Host: 192.168.1.100:8081
[ç»ˆæ­¢è¯·æ±‚] æ¥æºIP: 127.0.0.1, Host: localhost:8081
[æ‰§è¡Œç»ˆæ­¢] ç›®æ ‡è¿›ç¨‹: 12345, è¯·æ±‚æ¥æº: 127.0.0.1
[æˆåŠŸ] å·²å‘ PID 12345 å‘é€ SIGTERM ä¿¡å·
```

---

## âš™ï¸ é«˜çº§é…ç½®

### å•ä¾‹æ¨¡å¼
æœåŠ¡ç®¡ç†å™¨ä½¿ç”¨å•ä¾‹æ¨¡å¼ï¼Œå¤šæ¬¡è°ƒç”¨ `start_terminate_service()` ä¸ä¼šé‡å¤å¯åŠ¨æœåŠ¡ã€‚

```python
# ç¬¬ä¸€æ¬¡è°ƒç”¨ä¼šå¯åŠ¨æœåŠ¡
start_terminate_service(port=8081)

# ç¬¬äºŒæ¬¡è°ƒç”¨ä¼šè¿”å›å·²å­˜åœ¨çš„å®ä¾‹
start_terminate_service(port=8081)  # è¾“å‡º: [è­¦å‘Š] ç»ˆæ­¢æœåŠ¡å·²åœ¨ç«¯å£ 8081 è¿è¡Œ
```

### è·å–æœåŠ¡å®ä¾‹
```python
service = get_terminate_service()

# æŸ¥çœ‹æ—¥å¿—
service.print_logs()

# ä¿®æ”¹ç™½åå•
service.set_allowed_ips(['192.168.1.100'])

# åœæ­¢æœåŠ¡
service.stop()
```

---

## ğŸ› ï¸ é›†æˆåˆ°ä»£ç ç”Ÿæˆæ¨¡æ¿

åœ¨ `manage.py` ç”Ÿæˆç®—æ³•ä»£ç æ—¶ï¼Œæ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š

```python
# åœ¨ç”Ÿæˆçš„ç®—æ³•æ–‡ä»¶é¡¶éƒ¨æ·»åŠ å¯¼å…¥
import_code = """
import sys
import os
sys.path.append(os.path.join(os.path.dirname(__file__), '..', '..'))
from terminate_service_manager import start_terminate_service, get_terminate_service
"""

# åœ¨mainå‡½æ•°å¼€å§‹å¤„æ·»åŠ æœåŠ¡å¯åŠ¨
service_start_code = """
if start_terminate_service(port=8081):
    print(f"[ç»ˆæ­¢æœåŠ¡] å·²å¯åŠ¨åœ¨ç«¯å£ 8081, å½“å‰PID: {os.getpid()}")
"""
```

---

## â“ å¸¸è§é—®é¢˜

### Q1: ç«¯å£8081è¢«å ç”¨æ€ä¹ˆåŠï¼Ÿ
**A:** æœåŠ¡ä¼šè‡ªåŠ¨æ£€æµ‹å¹¶å¼ºåˆ¶å…³é—­å ç”¨8081ç«¯å£çš„è¿›ç¨‹ã€‚

### Q2: å¦‚ä½•æŸ¥çœ‹æœ‰å“ªäº›IPè®¿é—®è¿‡ï¼Ÿ
**A:** è°ƒç”¨ `service.print_logs()` æˆ–è®¿é—® `/logs` æ¥å£ã€‚

### Q3: å¦‚ä½•åªå…è®¸æœ¬åœ°è®¿é—®ï¼Ÿ
**A:** è®¾ç½®ç™½åå•ï¼š`allowed_ips=['127.0.0.1']`

### Q4: æœåŠ¡ä¼šè‡ªåŠ¨å…³é—­å—ï¼Ÿ
**A:** æœåŠ¡åœ¨åå°çº¿ç¨‹è¿è¡Œï¼Œç®—æ³•ç»“æŸæ—¶ä¼šéšä¸»è¿›ç¨‹å…³é—­ã€‚

---

## ğŸ“ å®Œæ•´è¿è¡Œç¤ºä¾‹

```bash
# 1. å¯åŠ¨ç®—æ³• (ä¼šè‡ªåŠ¨å¯åŠ¨8081æœåŠ¡)
python ç®—æ³•è°ƒç”¨ç¤ºä¾‹.py

# è¾“å‡º:
# ============================================================
# ç®—æ³•å¯åŠ¨ç¤ºä¾‹
# ============================================================
# 
# [1] å¯åŠ¨ç»ˆæ­¢æœåŠ¡...
# [å¯åŠ¨æˆåŠŸ] HTTPç»ˆæ­¢æœåŠ¡å·²å¯åŠ¨åœ¨ç«¯å£ 8081
# [ç›‘å¬åœ°å€] 0.0.0.0:8081
# [å½“å‰è¿›ç¨‹] PID: 12345
# [æˆåŠŸ] ç»ˆæ­¢æœåŠ¡å·²å¯åŠ¨åœ¨ 8081 ç«¯å£
# [æç¤º] å¯ä»¥é€šè¿‡ POST http://localhost:8081/terminate æ¥ç»ˆæ­¢æ­¤è¿›ç¨‹
# [å½“å‰PID] 12345
# 
# [2] å¼€å§‹æ‰§è¡Œç®—æ³•...
# ç®—æ³•æ­£åœ¨è¿è¡Œ...
# è¿­ä»£ 1/100
# [çŠ¶æ€æŸ¥è¯¢] æ¥æºIP: 127.0.0.1, Host: localhost:8081
# è¿­ä»£ 2/100
# [ç»ˆæ­¢è¯·æ±‚] æ¥æºIP: 192.168.1.100, Host: 192.168.1.100:8081
# [æ‰§è¡Œç»ˆæ­¢] ç›®æ ‡è¿›ç¨‹: 12345, è¯·æ±‚æ¥æº: 192.168.1.100
```

---

## ğŸ¯ æ€»ç»“

1. âœ… **è‡ªåŠ¨ç®¡ç†8081ç«¯å£** - è‡ªåŠ¨é‡Šæ”¾å ç”¨çš„ç«¯å£
2. âœ… **è®°å½•æ‰€æœ‰IP** - è¯¦ç»†è®°å½•æ¯ä¸ªè¯·æ±‚çš„æ¥æº
3. âœ… **å•ä¾‹æ¨¡å¼** - é¿å…é‡å¤å¯åŠ¨
4. âœ… **IPç™½åå•** - å¯é€‰çš„å®‰å…¨æ§åˆ¶
5. âœ… **JSONå“åº”** - ç»Ÿä¸€çš„APIæ ¼å¼
6. âœ… **æ˜“äºé›†æˆ** - ä¸¤è¡Œä»£ç å³å¯é›†æˆåˆ°ç®—æ³•ä¸­

